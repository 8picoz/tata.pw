---
title: RustでDXRを使ってパストレした話
---

この記事はレイトレアドカレの記事です。

今回作成したプロジェクトのリポジトリは[こちら](https://github.com/8picoz/rwr)です。

# windows-rsとwinapi-rs
これは後で書き直す

現在、RustでWindows APIを使いたい場合、有名なcrateが２つ存在して一つは[windows-rs](https://github.com/microsoft/windows-rs)、もう一つは[winapi-rs](https://github.com/retep998/winapi-rs)です。

[winapi-rs](https://github.com/retep998/winapi-rs)は完全に人の手で管理されている第三者のプロジェクトであり、こちらは自分が軽く調べてみたところDXRのサポートはあまり活発には[行っていなさそう](https://github.com/retep998/winapi-rs/pull/812)でした。


[windows-rs](https://github.com/microsoft/windows-rs)はマイクロソフトが公式で提供しているもので、[win32metadata](https://forest.watch.impress.co.jp/docs/news/1301910.html)を利用して自動的にapiを生成するcrate<sup>[[1]](https://blogs.windows.com/windowsdeveloper/2021/01/21/making-win32-apis-more-accessible-to-more-languages/)</sup>です。
こちらのプロジェクトはDXRに使用される構造体などが定義されてそうに見え、さらにComPtrなどでCOMオブジェクトを管理する場合、Rust上で行うとうまくライフタイムが管理してくれるという情報を見ました。

以上の理由から自分の場合は[windows-rs](https://github.com/microsoft/windows-rs)を採用しました。

# HLSLコンパイル
Visual Studio上でそのままHLSLを書くとビルド時に自動でコンパイルをしてくれるのですが、そのような機能は今回の環境ではないので自前でコンパイルしなくてはいけません。
そのためにはWindows SDKに付属している[HLSLコンパイラ(fxc.exe)](https://docs.microsoft.com/ja-jp/cpp/build/reference/hlsl-property-pages?view=msvc-170)を使用します。

# DXRのセットアップの流れについて

ここはD3D12全体のセットアップの流れではなく、DXRのみを抽出した流れです。

- シェーダーテーブルの作成
- グローバルルートシグネチャとローカルルートシグネチャについて
- 

# もしかして: 足りてる
# 足りないapiについて
実際に自分でラッパーをC++で書き、[rust-bindgen](https://github.com/rust-lang/rust-bindgen)を使用しバインディングを作成しました。

# HLSLのコンパイル
DXCを使うビルドスクリプトを用意してオフラインコンパイルしても良いのですが、パスが環境依存となるのがめんどくさいのでD3DCompileFromFile

しかしVisual Studioでの場合のようにビルドに引っ掛けることが出来ないので、実行時にコンパイルするD3DCompileFromFileなどを使いたいなと思うのですが、DXRがシェーダーモデル6.3以降でしか使用できないのでここはIDxcCompilerを使用します。

IDxcUtilsやIDxcCompilerが自分が探してみた限りでは見つからないため、ここはdxcを使用してオフラインコンパイルした結果をD3DReadFileToBlobを使用して読み込もうと思います

`dxc -T lib_6_4 "./test_shader.hlsl" -Fo ./output/test_shader.cso`


# Raytracing

# Rust特有の問題
引数のNoneかstd::ptr::null()のどちらなのかの判断がいまいちわかりにくかった
自分が作ったような構造だと、メンバにOptionとしてdeviceなどが載ってるので毎回取得してくるのにunwrapをしなければ行けない
しかしDx12::new()の部分ですべての初期化を行って最初からすべてのメンバが入った状態で返せばこれはなくなる
windows-rsが大きすぎるのでrust-analyzerがものすごくメモリを持っていく -> rlsを使う
TLASやBLASやそのScratchのバッファを取得するときに渡すポインタがOptionで包まれているので一度unwrapしなければならない
Blobを作成するのにD3DCreateBlobを使用した
ビルド時に成果物が生成される場所に自動でshadersもコピーするように作りたい
D3D12_EXPORT_DESCを作るときにワイド文字列として渡すためにUTF-16にしてVec<u16>として集めて*mut Vec<u16>を渡さなければいけない
as *mut _ as _のように生のポインタを渡さないといけないのか&mutのように可変参照だけで良いのかの判別が引数などのメタデータからわかりにくい

#まだやりたいところ
dx12.rs内でdeviceなどの必要なメンバをexceptでunwrapしているところを伝搬してpanicさせるかどうかを考える

# 感想
RustではResultがあるので、D3D12CreateDeviceなどの引数にポインタを渡して成功か失敗かを見るような設計はすべてResultで包まれていて良いなと感じました。(これはあとで書き直す) CreateSwapChainなどはちゃんとResultに包まれてたが通常のCppで書く場合と同様に生ポインタを渡す必要がある場合があり、これはCreateWindowExAのように返り値が基本hwndでlpparamにポインタとして渡す必要があったり、CheckFeatureSupportのようにその関数自体の失敗とその機能のサポートをしてないよという意味合いの失敗はごっちゃになったりするのでResultで包まれていない？
QueryInterface()ではなくIDXGISwapChainなどが内部にIUnknownという名前のInterfaceというトレイトを実装した構造体を保持していてそのIUnknownがvtableをもっていてそれがInterfaceの持つcast()というメソッドによりQueryInterfaceと同等の事ができるようになる
次回はこのリポジトリを元にパストレだったりGGXだったりをGPUで実装しようかなと思っていて、このRust + DXRの記事もこれからいくつか書こうかなと思っています。
あ、あとVulkan/VKRも触ってみたいですね。

# 参考文献
[Two Shader Compilers of Direct3D 12](https://asawicki.info/news_1719_two_shader_compilers_of_direct3d_12)
[Direct3D 12を始める – Command | shobomalog](https://shobomaru.wordpress.com/2015/04/20/d3d12-command/)
[DirectX-Headers/d3dx12.h at main · microsoft/DirectX-Headers](https://github.com/microsoft/DirectX-Headers/blob/main/include/directx/d3dx12.h)
[Direct3D12のデバッグを助けるID3D12Object::SetName: 新 masafumi's Diary](http://masafumi.cocolog-nifty.com/masafumis_diary/2016/02/direct3d12-601f.html)

とくに
microsoft/DirectX-Graphics-Samples: This repo contains the DirectX Graphics samples that demonstrate how to build graphics intensive applications on Windows.
https://github.com/microsoft/DirectX-Graphics-Samples
windows-samples-rs/main.rs at master · microsoft/windows-samples-rs
https://github.com/microsoft/windows-samples-rs/blob/master/direct3d12/src/main.rs
DirectX-Headers/d3dx12.h at main · microsoft/DirectX-Headers
https://github.com/microsoft/DirectX-Headers/blob/main/include/directx/d3dx12.h